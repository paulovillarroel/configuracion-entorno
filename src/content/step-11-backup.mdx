import Callout from '../components/Callout.astro';
import OsTabs from '../components/OsTabs.astro';

<Callout type="info" title="¬øQu√© es la estrategia 3-2-1?">
  **3** copias de tus datos, en **2** medios diferentes, con **1** copia fuera de tu ubicaci√≥n (la nube). Es el est√°ndar de la industria para no perder datos.

  <ul class="list-disc list-inside space-y-1 mt-2">
    <li><strong>Restic:</strong> Toma "fotos" (snapshots) de tu workspace. Solo guarda lo que cambi√≥ (deduplicaci√≥n), y todo queda encriptado autom√°ticamente.</li>
    <li><strong>Rclone:</strong> El "puente" que conecta Restic con servicios de nube (OneDrive, Google Drive, Dropbox). T√∫ eliges d√≥nde guardar.</li>
  </ul>
</Callout>

<div class="not-prose grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center text-sm">
  <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded border border-slate-200 dark:border-slate-700">
    <span class="text-2xl">üìÇ</span><br/><strong>Tu Workspace</strong><br/><span class="text-xs text-slate-500 dark:text-slate-400">C√≥digo Local</span>
  </div>
  <div class="flex items-center justify-center text-slate-400 dark:text-slate-500">
    ‚Üí Encriptaci√≥n ‚Üí
  </div>
  <div class="bg-blue-50 dark:bg-blue-950/30 p-3 rounded border border-blue-200 dark:border-blue-800">
    <span class="text-2xl">‚òÅÔ∏è</span><br/><strong>OneDrive</strong><br/><span class="text-xs text-slate-500 dark:text-slate-400">Snapshot Seguro</span>
  </div>
</div>

### 1. Instalaci√≥n

<OsTabs>
  <Fragment slot="win">
    <div class="prose prose-slate dark:prose-invert max-w-none">

```bash
sudo apt install -y rclone restic
```

    </div>
  </Fragment>
  <Fragment slot="mac">
    <div class="prose prose-slate dark:prose-invert max-w-none">

```bash
brew install rclone restic
```

    </div>
  </Fragment>
</OsTabs>

### 2. Configurar Nube

Ejecuta en tu terminal y sigue el asistente interactivo paso a paso:

```bash
rclone config
```

<div class="not-prose my-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg p-4">
  <p class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Responde as√≠ en cada pregunta:</p>
  <ol class="list-decimal list-inside text-sm text-slate-600 dark:text-slate-400 space-y-2">
    <li><strong>e/n/d/r/c/s/q&gt;</strong> ‚Üí escribe <code>n</code> (new remote) y presiona Enter.</li>
    <li><strong>name&gt;</strong> ‚Üí escribe <code>onedrive</code> y presiona Enter.</li>
    <li><strong>Storage&gt;</strong> ‚Üí busca el n√∫mero de <strong>"Microsoft OneDrive"</strong> (suele ser ~33), escr√≠belo y presiona Enter. Tambi√©n puedes escribir <code>onedrive</code> directamente.</li>
    <li><strong>client_id&gt;</strong> ‚Üí d√©jalo vac√≠o (solo presiona Enter).</li>
    <li><strong>client_secret&gt;</strong> ‚Üí d√©jalo vac√≠o (solo presiona Enter).</li>
    <li><strong>region&gt;</strong> ‚Üí escribe <code>1</code> (Microsoft Cloud Global) y presiona Enter.</li>
    <li><strong>Edit advanced config?</strong> ‚Üí escribe <code>n</code> y presiona Enter.</li>
    <li><strong>Use auto config?</strong> ‚Üí escribe <code>y</code>. Se abrir√° tu navegador para iniciar sesi√≥n con tu cuenta de Microsoft.</li>
    <li><strong>config_type&gt;</strong> ‚Üí escribe <code>1</code> (OneDrive Personal) y presiona Enter.</li>
    <li><strong>Drive OK?</strong> ‚Üí escribe <code>y</code> y presiona Enter.</li>
    <li><strong>y/e/d&gt;</strong> ‚Üí escribe <code>y</code> para confirmar y presiona Enter.</li>
    <li><strong>e/n/d/r/c/s/q&gt;</strong> ‚Üí escribe <code>q</code> para salir del asistente.</li>
  </ol>
  <p class="text-xs text-slate-500 dark:text-slate-400 mt-3">Si usas <strong>Google Drive</strong> o <strong>Dropbox</strong> en lugar de OneDrive, el proceso es similar: solo elige el servicio correspondiente en el paso 3.</p>
</div>

### 3. Inicializar & Script

```bash
restic -r rclone:onedrive:Backup_Curso init
```

<Callout type="warning" title="Contrase√±a de Restic">
  Este comando te pedir√° **crear una contrase√±a nueva** (no es la de tu sistema ni la de OneDrive). Es la clave que encripta tus backups.

  - **Escr√≠bela en un lugar seguro** (un gestor de contrase√±as, un papel guardado, etc.).
  - Si la pierdes, **no podr√°s recuperar tus backups**. No hay forma de resetearla.
  - Te la pedir√° cada vez que hagas un backup o restaures archivos.
</Callout>

Crea el script de automatizaci√≥n con un solo comando:

```bash
cat << 'SCRIPT' > ~/backup.sh
#!/bin/bash
# ============================
# Backup Blindado - Restic + Rclone
# ============================

# --- Variables configurables ---
REPO="rclone:onedrive:Backup_Curso"
SOURCE="$HOME/workspace"
RETENTION_DAYS=30
RETENTION_WEEKLY=8
RETENTION_MONTHLY=6

# --- Exclusiones ---
EXCLUDES=(
    --exclude="node_modules"
    --exclude=".venv"
    --exclude="__pycache__"
    --exclude=".Rproj.user"
    --exclude=".DS_Store"
    --exclude="*.tmp"
)

echo "=== Fase 1: Backup ==="
restic -r "$REPO" backup "$SOURCE" "${EXCLUDES[@]}" --verbose

echo "=== Fase 2: Limpieza de snapshots antiguos ==="
restic -r "$REPO" forget \
    --keep-daily "$RETENTION_DAYS" \
    --keep-weekly "$RETENTION_WEEKLY" \
    --keep-monthly "$RETENTION_MONTHLY" \
    --prune

echo "=== Fase 3: Verificaci√≥n de integridad ==="
restic -r "$REPO" check

echo "=== Backup completado: $(date) ==="
SCRIPT
chmod +x ~/backup.sh
```

<Callout type="tip" title="C√≥mo usar el script">
  - Ejecuci√≥n manual: `~/backup.sh`
  - Te pedir√° la contrase√±a de Restic que creaste arriba.
  - Para automatizar (cada d√≠a a las 2 AM):
</Callout>

```bash
crontab -e
```

Se abrir√° un editor de texto en la terminal. Si es **nano** (lo m√°s com√∫n): usa las flechas para ir al final del archivo, pega la siguiente l√≠nea, luego presiona **Ctrl+O** (guardar) y **Ctrl+X** (salir).

Agrega esta l√≠nea al final:

```bash
0 2 * * * RESTIC_PASSWORD="tu_password" ~/backup.sh >> ~/backup.log 2>&1
```

`0 2 * * *` = "a las 2:00 AM, todos los d√≠as". Reemplaza `tu_password` por la contrase√±a que creaste al inicializar Restic.

**Tip:** Revisa `~/backup.log` para confirmar que los backups corren sin errores.
